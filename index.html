<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="image/gps.ico">
  <title>位置連動忘れ物チェック</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap');

    :root {
      --bg-color: #121212;
      --primary-color: #1e88e5;
      --primary-hover: #1565c0;
      --text-color: #e0e0e0;
      --card-bg: #1f1f1f;
      --border-radius: 12px;
      --shadow-color: rgba(0, 0, 0, 0.6);
    }

    * {
      box-sizing: border-box;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: 'Roboto Mono', monospace, monospace;
      margin: 0;
      padding: 2rem 1rem;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    main {
      max-width: 480px;
      width: 100%;
    }

    h1 {
      font-weight: 700;
      font-size: 2rem;
      margin-bottom: 1rem;
      text-align: center;
      color: var(--primary-color);
      text-shadow: 0 0 8px var(--primary-color);
    }

    .card {
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 1.5rem 2rem;
      box-shadow: 0 6px 12px var(--shadow-color);
      margin-bottom: 1.5rem;
    }

    label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 0.3rem;
      user-select: none;
      color: #bbb;
    }

    input[type="number"],
    input[type="text"] {
      width: 100%;
      padding: 0.6rem 0.9rem;
      font-size: 1rem;
      border-radius: 8px;
      border: none;
      background-color: #2c2c2c;
      color: var(--text-color);
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.7);
      transition: background-color 0.3s ease;
    }
    input[type="number"]:focus,
    input[type="text"]:focus {
      background-color: #383838;
      outline: none;
      box-shadow: 0 0 8px var(--primary-color);
    }

    button {
      margin-top: 1rem;
      padding: 0.65rem 1.2rem;
      font-size: 1rem;
      font-weight: 600;
      color: white;
      background-color: var(--primary-color);
      border: none;
      border-radius: 32px;
      cursor: pointer;
      box-shadow: 0 4px 10px var(--primary-color);
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      user-select: none;
      display: inline-block;
    }
    button:hover:not(:disabled) {
      background-color: var(--primary-hover);
      box-shadow: 0 6px 14px var(--primary-hover);
    }
    button:disabled {
      background-color: #555;
      cursor: default;
      box-shadow: none;
    }

    #distance-info {
      text-align: center;
      font-size: 1.1rem;
      margin-bottom: 1rem;
      color: #aaa;
    }

    #checklist ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    #checklist li {
      background-color: #2a2a2a;
      border-radius: 8px;
      padding: 0.8rem 1rem;
      margin-bottom: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.8rem;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.6);
      transition: background-color 0.3s ease;
      cursor: pointer;
      user-select: none;
    }
    #checklist li:hover {
      background-color: #3a3a3a;
    }
    #checklist input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--primary-color);
      flex-shrink: 0;
    }

    #new-item {
      margin-top: 0.6rem;
      width: calc(100% - 6rem);
      display: inline-block;
      vertical-align: middle;
    }

    #btn-add-item {
      width: 4.5rem;
      vertical-align: middle;
    }

    @media (max-width: 520px) {
      body {
        padding: 1rem 0.5rem;
      }
      main {
        padding: 0 1rem;
      }
    }
  </style>
</head>
<body>
  <main>
    <h1>位置連動忘れ物チェック</h1>

    <section id="setup-section" class="card">
      <p>自宅の位置を設定してください（手入力か「現在地取得」ボタンで）:</p>
      <label>
        緯度 (latitude)
        <input type="number" step="0.000001" id="home-lat" placeholder="例: 35.6895" />
      </label>
      <label>
        経度 (longitude)
        <input type="number" step="0.000001" id="home-lng" placeholder="例: 139.6917" />
      </label>
      <button id="btn-get-location">現在地取得</button>
      <button id="btn-save-home">設定を保存</button>
    </section>

    <div id="distance-info"></div>

    <section id="checklist" class="card hidden">
      <h2>忘れ物チェックリスト</h2>
      <ul id="items-list"></ul>
      <input type="text" id="new-item" placeholder="忘れ物アイテムを追加" />
      <button id="btn-add-item">追加</button>
    </section>
  </main>

<script>
const DISTANCE_THRESHOLD = 20; // m

const homeLatInput = document.getElementById('home-lat');
const homeLngInput = document.getElementById('home-lng');
const btnGetLocation = document.getElementById('btn-get-location');
const btnSaveHome = document.getElementById('btn-save-home');
const distanceInfo = document.getElementById('distance-info');
const checklistDiv = document.getElementById('checklist');
const itemsList = document.getElementById('items-list');
const newItemInput = document.getElementById('new-item');
const btnAddItem = document.getElementById('btn-add-item');
const setupSection = document.getElementById('setup-section');

const LS_HOME_LAT = 'homeLatitude';
const LS_HOME_LNG = 'homeLongitude';
const LS_CHECKLIST = 'checklistItems';

// 通知の許可を求める
async function requestNotificationPermission() {
  if (!('Notification' in window)) {
    alert('このブラウザは通知に対応していません。');
    return false;
  }
  if (Notification.permission === 'granted') return true;
  if (Notification.permission !== 'denied') {
    const permission = await Notification.requestPermission();
    return permission === 'granted';
  }
  return false;
}

// Service Worker登録
async function registerServiceWorker() {
  if ('serviceWorker' in navigator) {
    try {
      const reg = await navigator.serviceWorker.register('/sw.js');
      console.log('Service Worker registered', reg);
      return reg;
    } catch (e) {
      console.error('Service Worker登録失敗:', e);
    }
  }
  return null;
}

// 通知表示
function showNotification(title, options) {
  if (Notification.permission === 'granted') {
    navigator.serviceWorker.getRegistration().then(reg => {
      if (reg) reg.showNotification(title, options);
      else new Notification(title, options);
    });
  }
}

function toRad(deg) { return deg * Math.PI / 180; }

function getDistance(lat1, lng1, lat2, lng2) {
  const R = 6371000;
  const dLat = toRad(lat2 - lat1);
  const dLng = toRad(lng2 - lng1);
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLng/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

function loadChecklist() {
  const json = localStorage.getItem(LS_CHECKLIST);
  if (!json) return [];
  try {
    return JSON.parse(json);
  } catch {
    return [];
  }
}
function saveChecklist(items) {
  localStorage.setItem(LS_CHECKLIST, JSON.stringify(items));
}
function renderChecklist() {
  const items = loadChecklist();
  itemsList.innerHTML = '';
  items.forEach((item, idx) => {
    const li = document.createElement('li');
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.id = `chk-${idx}`;
    checkbox.checked = false;
    checkbox.addEventListener('change', () => {
      if (checkbox.checked) {
        items.splice(idx,1);
        saveChecklist(items);
        renderChecklist();
      }
    });
    const label = document.createElement('label');
    label.htmlFor = checkbox.id;
    label.textContent = item;
    li.appendChild(checkbox);
    li.appendChild(label);
    itemsList.appendChild(li);
  });
}

// 通知用の制御フラグ（通知を連続で送りすぎないためのクールダウン）
let lastNotifyTime = 0;
const NOTIFY_COOLDOWN_MS = 5 * 60 * 1000; // 5分間隔で通知可能

async function checkDistanceAndNotify() {
  const hasPermission = await requestNotificationPermission();
  if (!hasPermission) {
    distanceInfo.textContent = '通知の許可が必要です。';
    return;
  }
  await registerServiceWorker();

  const homeLat = parseFloat(localStorage.getItem(LS_HOME_LAT));
  const homeLng = parseFloat(localStorage.getItem(LS_HOME_LNG));
  if (isNaN(homeLat) || isNaN(homeLng)) {
    distanceInfo.textContent = '自宅の位置が設定されていません。';
    checklistDiv.classList.add('hidden');
    return;
  }
  if (!navigator.geolocation) {
    distanceInfo.textContent = 'お使いのブラウザは位置情報をサポートしていません。';
    checklistDiv.classList.add('hidden');
    return;
  }
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const curLat = pos.coords.latitude;
      const curLng = pos.coords.longitude;
      const dist = getDistance(homeLat, homeLng, curLat, curLng);
      distanceInfo.textContent = `現在地は自宅から約 ${dist.toFixed(1)} m 離れています。`;

      if (dist > DISTANCE_THRESHOLD / 2) {
        checklistDiv.classList.remove('hidden');
        const now = Date.now();
        if (now - lastNotifyTime > NOTIFY_COOLDOWN_MS) {
          lastNotifyTime = now;
          showNotification('忘れ物チェック', {
            body: `自宅から${dist.toFixed(1)}m離れています。忘れ物がないか確認してね！`,
            icon: '/icon.png',
            vibrate: [200, 100, 200],
          });
        }
      } else {
        checklistDiv.classList.add('hidden');
      }
    },
    (err) => {
      distanceInfo.textContent = '位置情報の取得に失敗しました。許可を確認してください。';
      checklistDiv.classList.add('hidden');
    },
    { enableHighAccuracy: true, maximumAge: 10000, timeout: 5000 }
  );
}

btnGetLocation.addEventListener('click', () => {
  if (!navigator.geolocation) {
    alert('位置情報APIが利用できません。');
    return;
  }
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      homeLatInput.value = pos.coords.latitude.toFixed(6);
      homeLngInput.value = pos.coords.longitude.toFixed(6);
    },
    () => alert('現在地の取得に失敗しました。'),
    { enableHighAccuracy: true }
  );
});

btnSaveHome.addEventListener('click', () => {
  const lat = parseFloat(homeLatInput.value);
  const lng = parseFloat(homeLngInput.value);
  if (isNaN(lat) || isNaN(lng)) {
    alert('有効な緯度・経度を入力してください。');
    return;
  }
  localStorage.setItem(LS_HOME_LAT, lat);
  localStorage.setItem(LS_HOME_LNG, lng);
  alert('自宅の位置を保存しました。');
  setupSection.classList.add('hidden');
  checkDistanceAndNotify();
  renderChecklist();
  setInterval(checkDistanceAndNotify, 60 * 1000);
});

btnAddItem.addEventListener('click', () => {
  const item = newItemInput.value.trim();
  if (!item) return;
  const items = loadChecklist();
  items.push(item);
  saveChecklist(items);
  newItemInput.value = '';
  renderChecklist();
});

window.addEventListener('load', () => {
  const lat = localStorage.getItem(LS_HOME_LAT);
  const lng = localStorage.getItem(LS_HOME_LNG);
  if (lat && lng) {
    homeLatInput.value = lat;
    homeLngInput.value = lng;
    setupSection.classList.add('hidden');
    renderChecklist();
    checkDistanceAndNotify();
    setInterval(checkDistanceAndNotify, 60 * 1000);
  }
});
</script>

</body>
</html>